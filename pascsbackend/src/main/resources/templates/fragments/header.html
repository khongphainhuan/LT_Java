<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:fragment="header">
  <header class="d-flex align-items-center justify-content-between px-4 py-2 bg-white shadow-sm sticky-top">
    <!-- Logo & Tên hệ thống -->
    <div class="d-flex align-items-center gap-3">
      <a href="dashboard.html">
        <img src="images/logo.png" alt="PASCS" style="height:48px; border-radius:8px;">
      </a>
      <div class="d-flex flex-column">
        <span class="fw-bold text-primary fs-5">PASCS</span>
        <small class="text-muted">Public Administrative Service --- Commune / Ward</small>
      </div>
    </div>

    <!-- Người dùng & menu -->
    <div class="d-flex align-items-center gap-3">
      <div class="d-none d-md-block text-muted small">
        Vai trò: <span class="fw-semibold" id="userRole">Cán bộ</span>
      </div>
      <div class="dropdown">
        <a class="d-flex align-items-center btn btn-sm btn-outline-primary rounded-pill dropdown-toggle" href="#"
          role="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fas fa-user-circle fs-5 me-2"></i>
          <span id="userName">Cán bộ A</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-4 p-2">
          <li>
            <div class="px-3 py-2">
              <div class="fw-bold text-dark" id="menuUserName">User</div>
              <div class="small text-muted" id="menuUserRole">Role</div>
            </div>
          </li>
          <li>
            <hr class="dropdown-divider my-2">
          </li>
          <li><a class="dropdown-item rounded-3 py-2 mb-1 d-flex align-items-center gap-2"
              th:href="${profileUrl != null ? profileUrl : '#'}"
              onclick="if(this.getAttribute('href') === '#') return false;">
              <i class="fas fa-user text-primary me-2" style="width: 20px;"></i> Hồ sơ cá nhân
            </a></li>
          <li><a class="dropdown-item rounded-3 py-2 d-flex align-items-center gap-2" href="/citizen/dashboard">
              <i class="fas fa-home text-primary me-2" style="width: 20px;"></i> Trang chủ
            </a></li>
          <li>
            <hr class="dropdown-divider my-2">
          </li>
          <li><a class="dropdown-item rounded-3 py-2 text-danger d-flex align-items-center gap-2 bg-soft-danger"
              href="#" onclick="logout()">
              <i class="fas fa-sign-out-alt me-2" style="width: 20px;"></i> Đăng xuất
            </a></li>
        </ul>
      </div>
    </div>
  </header>

  <style>
    .bg-soft-danger {
      background-color: rgba(220, 53, 69, 0.1);
      color: #dc3545;
    }

    .bg-soft-danger:hover {
      background-color: rgba(220, 53, 69, 0.2);
      color: #b02a37;
    }
  </style>

  <script>
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/auth/login';
    }

    // Load user info
    document.addEventListener('DOMContentLoaded', async function () {
      try {
        // 1. Try to get user from API (Session based)
        let user = null;
        try {
          const response = await fetch('/api/auth/me');
          if (response.ok) {
            user = await response.json();
            // Update localStorage for backup
            localStorage.setItem('user', JSON.stringify(user));
          }
        } catch (err) {
          console.warn("Failed to fetch user info from API:", err);
        }

        // 2. Fallback to localStorage if API failed
        if (!user) {
          const userStr = localStorage.getItem('user');
          if (userStr) {
            user = JSON.parse(userStr);
          }
        }

        if (!user || !user.username) return;

        // 3. Update User Name (Display Name)
        // Note: JwtResponse doesn't have fullName, so we use username or email
        const displayName = user.fullName || user.username || user.email;
        const userNameEl = document.getElementById('userName');
        const menuUserNameEl = document.getElementById('menuUserName');

        if (userNameEl) userNameEl.textContent = displayName;
        if (menuUserNameEl) menuUserNameEl.textContent = displayName;

        // 4. Update User Role (Display Text)
        let roleDisplay = 'Người dùng';
        const role = (user.role || '').toUpperCase();

        if (role.includes('ADMIN')) {
          roleDisplay = 'Quản trị viên';
        } else if (role.includes('STAFF')) {
          roleDisplay = 'Cán bộ';
        } else if (role.includes('CITIZEN')) {
          roleDisplay = 'Công dân';
        }

        const userRoleEl = document.getElementById('userRole');
        const menuUserRoleEl = document.getElementById('menuUserRole');

        if (userRoleEl) userRoleEl.textContent = roleDisplay;
        if (menuUserRoleEl) menuUserRoleEl.textContent = roleDisplay;

        // 5. Update Profile & Home Links based on Role
        const profileLink = document.querySelector('a[href*="profile"]');
        const homeLink = document.querySelector('a[href*="dashboard"]');

        let newProfileLink = '/citizen/profile';
        let newHomeLink = '/citizen/dashboard';

        if (role.includes('ADMIN')) {
          newProfileLink = '/admin/settings';
          newHomeLink = '/admin/dashboard';
        } else if (role.includes('STAFF')) {
          newProfileLink = '/staff/profile';
          newHomeLink = '/staff/dashboard';
        }

        // Apply links
        if (profileLink) {
          profileLink.setAttribute('href', newProfileLink);
          profileLink.onclick = function (e) {
            e.preventDefault();
            window.location.href = newProfileLink;
          };
        }

        if (homeLink) {
          homeLink.setAttribute('href', newHomeLink);
        }

      } catch (e) {
        console.error("Error updating header:", e);
      }
    });
  </script>
</div>

</html>