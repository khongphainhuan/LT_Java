<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Hàng đợi công dân</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f8ff;
    }

    .status-badge {
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.9rem;
    }

    .bg-processing {
      background-color: #fff3cd;
      color: #856404;
    }

    .bg-done {
      background-color: #d1e7dd;
      color: #0f5132;
    }

    .bg-pending {
      background-color: #f8d7da;
      color: #842029;
    }
  </style>
</head>

<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="flex-grow-1 d-flex flex-column">
      <!-- Header -->
      <div th:replace="~{fragments/header :: header}"></div>

      <main class="p-4">
        <h4 class="fw-bold text-primary mb-4"><i class="bi bi-people"></i> Quản lý hàng đợi</h4>

        <div class="card shadow-sm border-0">
          <div class="card-body">
            <table class="table align-middle table-hover">
              <thead class="table-primary">
                <tr>
                  <th>#</th>
                  <th>Tên công dân</th>
                  <th>Dịch vụ</th>
                  <th>Thời gian đăng ký</th>
                  <th>Trạng thái</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody id="queue-table">
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">
                    <i class="bi bi-people fa-2x mb-3 opacity-25"></i>
                    <p>Không có người đang chờ</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <div th:replace="~{fragments/footer :: footer}"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      loadQueueData();
    });

    async function loadQueueData() {
      try {
        const response = await fetch('/api/queues/current');
        if (response.ok) {
          const queues = await response.json();
          displayQueue(queues);
        } else {
          console.error('Failed to load queue data');
        }
      } catch (error) {
        console.error('Error loading queue:', error);
      }
    }

    function displayQueue(queues) {
      const table = document.getElementById('queue-table');
      if (queues.length === 0) {
        table.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-muted py-4">
              <i class="bi bi-people fa-2x mb-3 opacity-25"></i>
              <p>Không có người đang chờ</p>
            </td>
          </tr>`;
        return;
      }

      table.innerHTML = queues.map((queue, index) => `
        <tr>
          <td>${queue.ticketNumber}</td>
          <td>${queue.user ? (queue.user.fullName || queue.user.username) : 'Khách vãng lai'}</td>
          <td>${queue.service ? queue.service.name : 'Chưa chọn'}</td>
          <td>${new Date(queue.createdAt).toLocaleTimeString('vi-VN')}</td>
          <td><span class="status-badge ${getStatusClass(queue.status)}">${getStatusName(queue.status)}</span></td>
          <td>
            <button class="btn btn-success btn-sm" onclick="callNext(${queue.id})">
              <i class="bi bi-telephone-forward"></i> Gọi
            </button>
            <a href="/staff/application-detail?id=${queue.id}" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-eye"></i> Xem
            </a>
          </td>
        </tr>
      `).join('');
    }

    function getStatusClass(status) {
      switch (status) {
        case 'WAITING': return 'bg-pending';
        case 'PROCESSING': return 'bg-processing';
        case 'COMPLETED': return 'bg-done';
        default: return 'bg-secondary text-white';
      }
    }

    function getStatusName(status) {
      switch (status) {
        case 'WAITING': return 'Chờ xử lý';
        case 'PROCESSING': return 'Đang xử lý';
        case 'COMPLETED': return 'Hoàn thành';
        case 'CANCELLED': return 'Đã hủy';
        default: return status;
      }
    }

    async function callNext(queueId) {
      // Assuming counterId is 1 for now, or fetch from user profile/local storage
      const counterId = 1;
      try {
        const response = await fetch(`/api/queues/call-next?counterId=${counterId}`, {
          method: 'POST'
        });

        if (response.ok) {
          alert('Đã gọi số tiếp theo!');
          loadQueueData();
        } else {
          const error = await response.json();
          alert('Lỗi: ' + (error.message || 'Không thể gọi số'));
        }
      } catch (error) {
        console.error('Error calling next:', error);
        alert('Lỗi kết nối!');
      }
    }
  </script>
</body>

</html>