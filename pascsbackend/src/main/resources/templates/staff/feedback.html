<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý phản hồi | PASCS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f8ff;
        }

        .star-display {
            color: #ffc107;
        }
    </style>
</head>

<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>

        <!-- Main Content -->
        <div class="flex-grow-1 d-flex flex-column">
            <!-- Header -->
            <div th:replace="~{fragments/header :: header}"></div>

            <main class="p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold text-primary mb-0">
                        <i class="bi bi-chat-dots"></i> Quản lý phản hồi
                    </h4>
                    <button class="btn btn-sm btn-primary" onclick="loadAllFeedback()">
                        <i class="bi bi-arrow-clockwise"></i> Làm mới
                    </button>
                </div>

                <!-- Thống kê -->
                <div class="row g-3 mb-4" id="statsCards">
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">Tổng phản hồi</h6>
                                <h3 class="text-primary fw-bold" id="totalFeedback">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">Đánh giá trung bình</h6>
                                <h3 class="text-warning fw-bold" id="avgRating">0.0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">5 sao</h6>
                                <h3 class="text-success fw-bold" id="fiveStars">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">1-2 sao</h6>
                                <h3 class="text-danger fw-bold" id="lowRatings">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Danh sách feedback -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Danh sách phản hồi</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Công dân</th>
                                        <th>Dịch vụ</th>
                                        <th>Đánh giá</th>
                                        <th>Nhận xét</th>
                                        <th>Ngày gửi</th>
                                    </tr>
                                </thead>
                                <tbody id="feedbackTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            Đang tải dữ liệu...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Footer -->
            <div th:replace="~{fragments/footer :: footer}"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadAllFeedback();
        });

        async function loadAllFeedback() {
            try {
                const response = await fetch('/api/feedback', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const feedbacks = await response.json();
                    displayFeedback(feedbacks);
                    calculateStats(feedbacks);
                } else if (response.status === 401) {
                    window.location.href = '/auth/login';
                } else {
                    console.error('Failed to load feedback');
                }
            } catch (error) {
                console.error('Error loading feedback:', error);
                document.getElementById('feedbackTableBody').innerHTML =
                    '<tr><td colspan="6" class="text-center text-danger py-4">Không thể tải dữ liệu phản hồi</td></tr>';
            }
        }

        function displayFeedback(feedbacks) {
            const tbody = document.getElementById('feedbackTableBody');

            if (!feedbacks || feedbacks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">Chưa có phản hồi nào</td></tr>';
                return;
            }

            tbody.innerHTML = feedbacks.map((feedback, index) => {
                const stars = generateStars(feedback.rating);
                const userName = feedback.user ? feedback.user.fullName : 'N/A';
                const serviceName = feedback.service ? feedback.service.name : 'Dịch vụ chung';
                const date = new Date(feedback.createdAt).toLocaleString('vi-VN');
                const comment = feedback.comment || 'Không có nhận xét';

                return `
          <tr>
            <td>${index + 1}</td>
            <td>${userName}</td>
            <td>${serviceName}</td>
            <td class="star-display">${stars}</td>
            <td style="max-width: 300px;">
              <div class="text-truncate" title="${comment}">
                ${comment}
              </div>
            </td>
            <td><small>${date}</small></td>
          </tr>
        `;
            }).join('');
        }

        function generateStars(rating) {
            const filled = '★'.repeat(rating);
            const empty = '☆'.repeat(5 - rating);
            return filled + empty;
        }

        function calculateStats(feedbacks) {
            if (!feedbacks || feedbacks.length === 0) {
                document.getElementById('totalFeedback').textContent = '0';
                document.getElementById('avgRating').textContent = '0.0';
                document.getElementById('fiveStars').textContent = '0';
                document.getElementById('lowRatings').textContent = '0';
                return;
            }

            const total = feedbacks.length;
            const totalRating = feedbacks.reduce((sum, f) => sum + f.rating, 0);
            const avg = (totalRating / total).toFixed(1);
            const fiveStars = feedbacks.filter(f => f.rating === 5).length;
            const lowRatings = feedbacks.filter(f => f.rating <= 2).length;

            document.getElementById('totalFeedback').textContent = total;
            document.getElementById('avgRating').textContent = avg;
            document.getElementById('fiveStars').textContent = fiveStars;
            document.getElementById('lowRatings').textContent = lowRatings;
        }
    </script>
</body>

</html>